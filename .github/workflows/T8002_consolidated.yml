name: T8002 Consolidated Build

on:
  - workflow_dispatch 
  - push
  
jobs:
    build:
      runs-on: macos-latest
  
      steps:
        - name: Clone Sources
          run: |
            git clone --branch 6153/dev https://github.com/Zormeister/xnu ~/xnu-6153.144.1~2
            git clone --branch rel/dtrace-338 https://github.com/apple-oss-distributions/dtrace.git ~/dtrace
            git clone --branch rel/libplatform-220 https://github.com/apple-oss-distributions/libplatform.git ~/libplatform
            git clone --branch rel/AvailabilityVersions-45 https://github.com/apple-oss-distributions/AvailabilityVersions.git ~/AvailabilityVersions
            git clone --branch rel/libdispatch-1173 https://github.com/apple-oss-distributions/libdispatch.git ~/libdispatch
            git clone  https://github.com/Zormeister/EmbeddedDeviceMap.git ~/EmbeddedDeviceMap
        - name: Install Homebrew Packages
          run: |
            brew install jsoncpp
        - name: Install availability.pl
          run: |
            mkdir -p $(xcrun --sdk macosx -show-sdk-path)/usr/local/libexec
            cp ~/AvailabilityVersions/availability.pl $(xcrun --sdk macosx -show-sdk-path)/usr/local/libexec/availability.pl
        - name: Install libplatform Headers
          run: |
            mkdir -p $(xcrun --sdk macosx -show-sdk-path)/usr/local/include/os/internal
            cp ~/libplatform/private/os/internal/* $(xcrun --sdk macosx -show-sdk-path)/usr/local/include/os/internal/
        - name: Install EmbeddedDeviceMap
          run: |
            cd ~/EmbeddedDeviceMap
            make DESTDIR=$(xcrun --sdk macosx -show-sdk-platform-path) install
        - name: Install ctfconvert, ctfdump and ctfmerge.
          run: |
            cd ~/dtrace
            echo "#include <stdint.h>" > include/llvm-Support/DataTypes.h
            sed -i -e 's,include "llvm/Support/DataTypes,include "llvm-Support/DataTypes,' include/llvm-Support/PointerLikeTypeTraits.h
            patch -Np1 -i ~/xnu*/patches/ctfmerge-*-DebugLevel4.patch
            xcodebuild install CODE_SIGNING_ALLOWED=NO DSTROOT=$(xcrun --sdk macosx -show-sdk-platform-path) INSTALL_PATH="/usr/local/bin" -target ctfconvert -target ctfdump -target ctfmerge -sdk macosx
        - name: Install XNU headers
          run: |
            export RC_ProjectNameAndSourceVersion="xnu-6153.144.1"
            export RC_ProjectBuildVersion="2"
            export MAKEFLAGS="--jobs=3"
            cd ~/xnu*/
            make EMBEDDED_DEVICE_MAP=$(xcrun -f embedded_device_map) EDM_DBPATH=$(xcrun --sdk macosx -show-sdk-platform-path)/usr/local/standalone/firmware/device_map.db DO_CTFMERGE=0 USE_WERROR=0 OBJROOT=$PWD DSTROOT=$(xcrun --sdk macosx -show-sdk-path) PRODUCT_CONFIGS="x619" installhdrs
        - name: Prepare libfirehose_kernel
          run: |
            cd ~/libdispatch
            mkdir -p $(xcrun --sdk macosx -show-sdk-path)/usr/local/include/os
            cp ~/libdispatch/os/firehose_buffer_private.h $(xcrun --sdk macosx -show-sdk-path)/usr/local/include/os
            awk '/include "<DEVELOPER/ {next;} /SDKROOT =/ {print "SDKROOT = macosx"; next;} {print $0}' xcodeconfig/libdispatch.xcconfig > .__tmp__ && mv -f .__tmp__ xcodeconfig/libdispatch.xcconfig
            xcodebuild install VALID_ARCHS="x86_64 x86_64h arm64 armv7 armv7k" DSTROOT=$(xcrun --sdk macosx -show-sdk-path) -target libfirehose_kernel -arch armv7 -arch armv7k
        - name: Build XNU
          run: |
            export RC_ProjectNameAndSourceVersion="xnu-6153.144.1"
            export RC_ProjectBuildVersion="2"
            export MAKEFLAGS="--jobs=3"
            cd ~/xnu*/
            make EMBEDDED_DEVICE_MAP=$(xcrun -f embedded_device_map) EDM_DBPATH=$(xcrun --sdk macosx -show-sdk-platform-path)/usr/local/standalone/firmware/device_map.db DO_CTFMERGE=0 USE_WERROR=0 XNU_LOGCOLORS=y KERNEL_CONFIGS="RELEASE DEVELOPMENT DEBUG" OBJROOT=$PWD PRODUCT_CONFIGS="x619"  RC_DARWIN_KERNEL_VERSION="19.6.0"
            make EMBEDDED_DEVICE_MAP=$(xcrun -f embedded_device_map) EDM_DBPATH=$(xcrun --sdk macosx -show-sdk-platform-path)/usr/local/standalone/firmware/device_map.db DO_CTFMERGE=0 DSTROOT=$PWD/KernelRoot USE_WERROR=0 KERNEL_CONFIGS="RELEASE DEVELOPMENT DEBUG" OBJROOT=$PWD PRODUCT_CONFIGS="x619" RC_DARWIN_KERNEL_VERSION="19.6.0" install
            make EMBEDDED_DEVICE_MAP=$(xcrun -f embedded_device_map) EDM_DBPATH=$(xcrun --sdk macosx -show-sdk-platform-path)/usr/local/standalone/firmware/device_map.db DO_CTFMERGE=0 DSTROOT=$PWD/KernelRoot USE_WERROR=0 KERNEL_CONFIGS="RELEASE DEVELOPMENT DEBUG" OBJROOT=$PWD PRODUCT_CONFIGS="x619" RC_DARWIN_KERNEL_VERSION="19.6.0" install_config
        - name: Package KernelRoot into a tarball
          run: |
            cd ~/xnu*/
            cd $PWD/KernelRoot
            tar -cvf T8002ConsolidatedRoot.tar.xz .
        - name: Upload Kernel Root tarball
          if: success()
          uses: actions/upload-artifact@v4
          with:
            name: T8002ConsolidatedRoot.tar.xz
            path: /Users/runner/xnu-6153.144.1~2/KernelRoot/T8002ConsolidatedRoot.tar.xz
